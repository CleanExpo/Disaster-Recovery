generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Agency {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?
  logo        String?
  primaryColor String  @default("#3B82F6")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  clients     Client[]
  audits      Audit[]
  proposals   Proposal[]
  invoices    Invoice[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("CLIENT")
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  agencyId      String?
  agency        Agency?   @relation(fields: [agencyId], references: [id])
  
  clients       Client[]
  audits        Audit[]
  proposals     Proposal[]
  notifications Notification[]
}

model Client {
  id           String   @id @default(cuid())
  businessName String
  contactName  String
  email        String
  phone        String?
  website      String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  industry     String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  agencyId     String
  agency       Agency   @relation(fields: [agencyId], references: [id])
  
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])
  
  audits       Audit[]
  proposals    Proposal[]
  invoices     Invoice[]
  enquiries    Enquiry[]
}

model Audit {
  id          String      @id @default(cuid())
  title       String
  description String?
  status      String      @default("DRAFT")
  version     Int         @default(1)
  shareToken  String?     @unique
  findings    String?
  metrics     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  sharedAt    DateTime?
  
  agencyId    String
  agency      Agency      @relation(fields: [agencyId], references: [id])
  
  clientId    String
  client      Client      @relation(fields: [clientId], references: [id])
  
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])
  
  proposals   Proposal[]
}

model Proposal {
  id          String   @id @default(cuid())
  title       String
  description String?
  content     String
  status      String   @default("DRAFT")
  shareToken  String?  @unique
  price       Float?
  validUntil  DateTime?
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  agencyId    String
  agency      Agency   @relation(fields: [agencyId], references: [id])
  
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])
  
  auditId     String?
  audit       Audit?   @relation(fields: [auditId], references: [id])
  
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  
  invoice     Invoice?
}

model Invoice {
  id          String        @id @default(cuid())
  invoiceNumber String      @unique
  amount      Float
  tax         Float         @default(0)
  total       Float
  status      String        @default("PENDING")
  dueDate     DateTime
  paidAt      DateTime?
  stripeInvoiceId String?   @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  agencyId    String
  agency      Agency        @relation(fields: [agencyId], references: [id])
  
  clientId    String
  client      Client        @relation(fields: [clientId], references: [id])
  
  proposalId  String?       @unique
  proposal    Proposal?     @relation(fields: [proposalId], references: [id])
}

model Enquiry {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  message     String
  source      String?
  metadata    String?
  responded   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
}

model Notification {
  id          String   @id @default(cuid())
  type        String
  title       String
  message     String
  read        Boolean  @default(false)
  metadata    String?
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// Lead Management Models
model Lead {
  id                    String   @id @default(cuid())
  
  // Contact Information
  fullName              String
  phone                 String
  email                 String
  
  // Property Information
  propertyType          String
  propertyAddress       String
  suburb                String
  state                 String
  postcode              String
  
  // Damage Information
  damageType            String   // JSON array stored as string
  damageDate            DateTime
  damageDescription     String
  estimatedAreaAffected String
  
  // Insurance Information
  hasInsurance          Boolean
  insuranceCompany      String?
  claimNumber           String?
  excessAmount          String?
  
  // Value Indicators
  urgencyLevel          String
  propertyValue         String
  isBusinessProperty    Boolean
  requiresAccommodation Boolean
  
  // Lead Quality
  leadScore             Int
  leadValue             Float
  hasPhotos             Boolean
  readyToStart          String
  budget                String?
  decisionMaker         Boolean
  qualityStatus         String   // HIGH_VALUE, QUALIFIED, STANDARD
  
  // Tracking
  source                String?
  ipAddress             String?
  userAgent             String?
  status                String   @default("NEW") // NEW, ASSIGNED, ACCEPTED, REJECTED, COMPLETED
  
  // Assignment
  partnerId             String?
  partner               Partner? @relation(fields: [partnerId], references: [id])
  assignedAt            DateTime?
  acceptedAt            DateTime?
  rejectedAt            DateTime?
  completedAt           DateTime?
  
  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  billing               PartnerBilling[]
  tracking              LeadTracking[]
  notes                 LeadNote[]
}

model Partner {
  id                String   @id @default(cuid())
  businessName      String
  contactName       String
  email             String   @unique
  phone             String
  abn               String?
  
  // Service Information
  serviceAreas      String   // JSON array of suburbs/postcodes
  specializations   String   // JSON array of damage types
  certifications    String?  // JSON array
  insuranceApproved Boolean  @default(false)
  
  // Account Information
  leadCredits       Float    @default(0)
  accountBalance    Float    @default(0)
  creditLimit       Float    @default(5000)
  paymentTerms      Int      @default(7) // days
  
  // Settings
  autoAcceptScore   Int      @default(80)
  maxLeadsPerDay    Int      @default(10)
  receiveEmergency  Boolean  @default(true)
  receiveCommercial Boolean  @default(true)
  
  // Status
  status            String   @default("PENDING") // PENDING, ACTIVE, SUSPENDED
  verifiedAt        DateTime?
  suspendedAt       DateTime?
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  leads             Lead[]
  billing           PartnerBilling[]
  payments          PartnerPayment[]
}

model PartnerBilling {
  id          String   @id @default(cuid())
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  
  amount      Float
  status      String   @default("PENDING") // PENDING, PAID, CANCELLED, REFUNDED
  dueDate     DateTime
  paidAt      DateTime?
  
  // Payment Information
  paymentMethod String?
  transactionId String?
  invoiceNumber String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PartnerPayment {
  id          String   @id @default(cuid())
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  
  amount      Float
  type        String   // CREDIT_PURCHASE, LEAD_PAYMENT, REFUND
  method      String   // CARD, BANK_TRANSFER, PAYPAL
  status      String   // PENDING, COMPLETED, FAILED
  
  transactionId String?
  description String?
  
  createdAt   DateTime @default(now())
}

model LeadTracking {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  
  event       String   // VIEWED, ACCEPTED, REJECTED, CONTACTED, QUOTED, WON, LOST
  metadata    String?  // JSON string with event details
  
  createdAt   DateTime @default(now())
}

model LeadNote {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  
  note        String
  type        String   // INTERNAL, PARTNER, CUSTOMER
  author      String
  
  createdAt   DateTime @default(now())
}
// ============================================
// NRP Contractor CRM Models
// ============================================
model Contractor {
  id                    String   @id @default(cuid())
  
  // Authentication
  username              String   @unique
  email                 String   @unique
  passwordHash          String
  passwordResetToken    String?
  passwordResetExpiry   DateTime?
  emailVerified         Boolean  @default(false)
  emailVerificationToken String?
  
  // Two-Factor Authentication
  twoFactorEnabled      Boolean  @default(false)
  twoFactorSecret       String?
  twoFactorBackupCodes  String?  // JSON array of encrypted backup codes
  
  // Contact Information
  mobileNumber          String
  mobileVerified        Boolean  @default(false)
  
  // Status
  status                String   @default("PENDING") // PENDING, UNDER_REVIEW, APPROVED, SUSPENDED, REJECTED
  onboardingStep        Int      @default(1)
  onboardingCompleted   Boolean  @default(false)
  approvedAt            DateTime?
  rejectedAt            DateTime?
  suspendedAt           DateTime?
  rejectionReason       String?
  
  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastLoginAt           DateTime?
  
  // Relations
  companyProfile        ContractorCompany?
  certifications        ContractorCertification[]
  insurance             ContractorInsurance[]
  references            ContractorReference[]
  backgroundChecks      BackgroundCheck[]
  subscription          ContractorSubscription?
  documents             ContractorDocument[]
  territories           ContractorTerritory[]
  kpiMetrics            ContractorKPI[]
  notifications         ContractorNotification[]
  auditLogs             ContractorAuditLog[]
  agreements            ContractorAgreement[]
  trainings             ContractorTraining[]
  projects              ContractorProject[]
  supportTickets        ContractorSupport[]
}

model ContractorCompany {
  id                    String   @id @default(cuid())
  contractorId          String   @unique
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Company Details
  companyName           String
  tradingName           String?
  abn                   String   @unique
  acn                   String?
  companyStructure      String   // SOLE_TRADER, PARTNERSHIP, PTY_LTD, TRUST
  
  // Addresses
  registeredAddress     String
  registeredCity        String
  registeredState       String
  registeredPostcode    String
  
  mailingAddress        String?
  mailingCity           String?
  mailingState          String?
  mailingPostcode       String?
  
  // Contact Details
  officePhone           String?
  officeFax             String?
  website               String?
  companyEmail          String?
  
  // Directors/Owners
  directors             String   // JSON array of director objects
  
  // Branding
  companyLogo           String?  // URL to uploaded logo
  brandColors           String?  // JSON object
  
  // Verification
  abnVerified           Boolean  @default(false)
  abnVerifiedAt         DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model ContractorCertification {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  certificationType     String   // CPP40421, IICRC_WRT, IICRC_ASD, IICRC_AMRT, etc.
  certificationName     String
  certificationNumber   String
  issuingOrganization   String
  issueDate             DateTime
  expiryDate            DateTime?
  
  // Verification
  documentUrl           String   // URL to uploaded certificate
  verified              Boolean  @default(false)
  verifiedAt            DateTime?
  verifiedBy            String?
  verificationNotes     String?
  
  // Status
  status                String   @default("PENDING") // PENDING, VERIFIED, EXPIRED, REJECTED
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model ContractorInsurance {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  insuranceType         String   // PUBLIC_LIABILITY, PROFESSIONAL_INDEMNITY, WORKERS_COMP
  insurer               String
  policyNumber          String
  coverageAmount        Float
  excess                Float?
  
  effectiveDate         DateTime
  expiryDate            DateTime
  
  // Certificate of Currency
  certificateUrl        String   // URL to uploaded certificate
  
  // Verification
  verified              Boolean  @default(false)
  verifiedAt            DateTime?
  verifiedBy            String?
  
  // Status
  status                String   @default("PENDING") // PENDING, ACTIVE, EXPIRED, CANCELLED
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([expiryDate])
}

model ContractorReference {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  referenceName         String
  companyName           String
  position              String
  email                 String
  phone                 String
  relationship          String   // CLIENT, SUPPLIER, PARTNER, OTHER
  projectDescription    String?
  
  // Verification
  contacted             Boolean  @default(false)
  contactedAt           DateTime?
  rating                Int?     // 1-5
  feedback              String?
  verified              Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model BackgroundCheck {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  checkType             String   // CRIMINAL, CREDIT, IDENTITY, QUALIFICATION
  provider              String   // Third-party provider name
  providerReference     String?
  
  // Consent
  consentGiven          Boolean
  consentDate           DateTime
  consentDocument       String?  // URL to signed consent
  
  // Results
  status                String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED
  result                String?  // CLEAR, FLAGGED, REQUIRES_REVIEW
  resultDetails         String?  // JSON object with detailed results
  reportUrl             String?  // URL to full report
  
  // Scoring
  riskScore             Int?     // 0-100
  riskLevel             String?  // LOW, MEDIUM, HIGH
  
  requestedAt           DateTime @default(now())
  completedAt           DateTime?
  expiresAt             DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model ContractorSubscription {
  id                    String   @id @default(cuid())
  contractorId          String   @unique
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Subscription Details
  tier                  String   // TIER_25KM, TIER_50KM, TIER_75KM, TIER_100KM, RURAL
  status                String   @default("PENDING") // PENDING, ACTIVE, SUSPENDED, CANCELLED
  
  // Coverage
  baseRadius            Int      // in kilometers
  additionalTerritories String?  // JSON array of additional coverage areas
  
  // Billing
  billingFrequency      String   @default("MONTHLY") // MONTHLY, QUARTERLY, ANNUAL
  amount                Float
  nextBillingDate       DateTime?
  
  // Payment Method
  paymentMethod         String?  // DIRECT_DEBIT, CREDIT_CARD
  paymentDetails        String?  // Encrypted payment details
  
  // Performance Bond
  bondAmount            Float    @default(5000)
  bondStatus            String   @default("PENDING") // PENDING, SECURED, RELEASED
  bondSecuredDate       DateTime?
  
  // Dates
  startDate             DateTime?
  endDate               DateTime?
  cancelledAt           DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  payments              ContractorPayment[]
  invoices              ContractorInvoice[]
}

model ContractorPayment {
  id                    String   @id @default(cuid())
  subscriptionId        String
  subscription          ContractorSubscription @relation(fields: [subscriptionId], references: [id])
  
  amount                Float
  type                  String   // SUBSCRIPTION, BOND, BACKGROUND_CHECK, OTHER
  status                String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, REFUNDED
  
  paymentMethod         String
  transactionId         String?
  failureReason         String?
  
  dueDate               DateTime
  paidAt                DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model ContractorInvoice {
  id                    String   @id @default(cuid())
  subscriptionId        String
  subscription          ContractorSubscription @relation(fields: [subscriptionId], references: [id])
  
  invoiceNumber         String   @unique
  amount                Float
  gst                   Float
  total                 Float
  
  status                String   @default("DRAFT") // DRAFT, ISSUED, PAID, OVERDUE, CANCELLED
  
  issueDate             DateTime
  dueDate               DateTime
  paidAt                DateTime?
  
  items                 String   // JSON array of line items
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([invoiceNumber])
}

model ContractorDocument {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  documentType          String   // CERTIFICATION, INSURANCE, ID, REFERENCE, PROJECT, OTHER
  documentName          String
  fileName              String
  fileUrl               String
  fileSize              Int
  mimeType              String
  
  // Metadata
  category              String?
  tags                  String?  // JSON array
  description           String?
  
  // Verification
  verified              Boolean  @default(false)
  verifiedAt            DateTime?
  verifiedBy            String?
  
  // Expiry
  expiryDate            DateTime?
  expiryNotificationSent Boolean @default(false)
  
  uploadedAt            DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([documentType, expiryDate])
}

model ContractorTerritory {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Territory Definition
  type                  String   // RADIUS, POSTCODE, SUBURB, LGA, STATE
  name                  String
  
  // For radius-based
  centerLat             Float?
  centerLng             Float?
  radiusKm              Float?
  
  // For area-based
  postcodes             String?  // JSON array
  suburbs               String?  // JSON array
  
  // Service Preferences
  emergencyResponse     Boolean  @default(true)
  afterHours            Boolean  @default(false)
  weekendService        Boolean  @default(true)
  
  // Capacity
  maxJobsPerDay         Int      @default(5)
  currentActiveJobs     Int      @default(0)
  
  // Status
  active                Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([type, active])
}

model ContractorKPI {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Period
  periodType            String   // MONTHLY, QUARTERLY, ANNUAL
  periodStart           DateTime
  periodEnd             DateTime
  
  // Performance Metrics
  totalJobs             Int      @default(0)
  completedJobs         Int      @default(0)
  averageResponseTime   Float?   // in hours
  averageCompletionTime Float?   // in days
  
  // Quality Metrics
  customerSatisfaction  Float?   // 0-5 rating
  qualityScore          Float?   // 0-100
  complianceScore       Float?   // 0-100
  
  // Clean Claims Integration
  cleanClaimsScore      Float?   // 0-100
  carsiCompliance       Float?   // 0-100
  
  // Financial
  totalRevenue          Float?
  averageJobValue       Float?
  
  // Issues
  complaints            Int      @default(0)
  violations            Int      @default(0)
  
  calculatedAt          DateTime @default(now())
  
  @@unique([contractorId, periodType, periodStart])
  @@index([periodType, periodStart])
}

model ContractorAgreement {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  agreementType         String   // PARTNERSHIP, CODE_OF_CONDUCT, WHS, PRIVACY, NDA
  agreementName         String
  version               String
  
  // Content
  documentUrl           String?  // URL to agreement document
  content               String?  // Agreement text
  
  // Acceptance
  accepted              Boolean  @default(false)
  acceptedAt            DateTime?
  acceptanceMethod      String?  // DIGITAL_SIGNATURE, CHECKBOX, EMAIL
  ipAddress             String?
  userAgent             String?
  
  // Digital Signature
  signatureData         String?  // Base64 encoded signature image
  signedName            String?
  signedPosition        String?
  
  // Validity
  effectiveDate         DateTime
  expiryDate            DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([agreementType, accepted])
}

model ContractorTraining {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  trainingType          String   // CARSI, WHS, TECHNICAL, COMPLIANCE, PRODUCT
  trainingName          String
  provider              String
  
  // Progress
  status                String   @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  progress              Int      @default(0) // 0-100
  
  // Completion
  completedAt           DateTime?
  certificateUrl        String?
  certificateNumber     String?
  
  // CEU Points
  ceuPoints             Float?
  
  // Validity
  validFrom             DateTime?
  validUntil            DateTime?
  
  // Tracking
  enrolledAt            DateTime @default(now())
  lastAccessedAt        DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([trainingType, status])
}

model ContractorProject {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  projectName           String
  projectType           String   // WATER, FIRE, MOLD, STORM, BIOHAZARD
  clientName            String
  location              String
  
  // Timeline
  startDate             DateTime
  endDate               DateTime?
  duration              Int?     // in days
  
  // Scope
  scopeOfWork           String   // Detailed description
  areaAffected          Float?   // in square meters
  
  // Financial
  projectValue          Float?
  insuranceCompany      String?
  claimNumber           String?
  
  // Documentation
  beforePhotos          String?  // JSON array of photo URLs
  afterPhotos           String?  // JSON array of photo URLs
  reportUrl             String?
  
  // Quality
  customerRating        Float?   // 0-5
  customerFeedback      String?
  
  // Used for verification
  canContact            Boolean  @default(false)
  contactName           String?
  contactPhone          String?
  contactEmail          String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([projectType, startDate])
}

model ContractorNotification {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  type                  String   // SYSTEM, COMPLIANCE, EXPIRY, PAYMENT, JOB, TRAINING
  priority              String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  subject               String
  message               String
  
  // Actions
  actionRequired        Boolean  @default(false)
  actionUrl             String?
  actionDeadline        DateTime?
  
  // Status
  read                  Boolean  @default(false)
  readAt                DateTime?
  dismissed             Boolean  @default(false)
  dismissedAt           DateTime?
  
  // Delivery
  emailSent             Boolean  @default(false)
  smsSent               Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  
  @@index([type, read, priority])
}

model ContractorSupport {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  ticketNumber          String   @unique
  category              String   // TECHNICAL, BILLING, COMPLIANCE, GENERAL
  priority              String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  subject               String
  description           String
  
  status                String   @default("OPEN") // OPEN, IN_PROGRESS, WAITING, RESOLVED, CLOSED
  
  // Assignment
  assignedTo            String?
  assignedAt            DateTime?
  
  // Resolution
  resolution            String?
  resolvedAt            DateTime?
  closedAt              DateTime?
  
  // Satisfaction
  satisfactionRating    Int?     // 1-5
  satisfactionFeedback  String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  messages              SupportMessage[]
  
  @@index([ticketNumber])
  @@index([status, priority])
}

model SupportMessage {
  id                    String   @id @default(cuid())
  supportTicketId       String
  supportTicket         ContractorSupport @relation(fields: [supportTicketId], references: [id], onDelete: Cascade)
  
  message               String
  isInternal            Boolean  @default(false)
  
  authorId              String
  authorType            String   // CONTRACTOR, ADMIN, SYSTEM
  authorName            String
  
  attachments           String?  // JSON array of attachment URLs
  
  createdAt             DateTime @default(now())
}

model ContractorAuditLog {
  id                    String   @id @default(cuid())
  contractorId          String
  contractor            Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  action                String   // LOGIN, LOGOUT, UPDATE_PROFILE, UPLOAD_DOCUMENT, etc.
  category              String   // AUTH, PROFILE, DOCUMENT, PAYMENT, COMPLIANCE
  
  details               String?  // JSON object with action details
  
  ipAddress             String?
  userAgent             String?
  
  performedBy           String   // User ID who performed the action
  performedByType       String   // CONTRACTOR, ADMIN, SYSTEM
  
  createdAt             DateTime @default(now())
  
  @@index([category, createdAt])
  @@index([action, createdAt])
}

// ============================================
// MISSING MODELS - Added for MVP functionality
// ============================================

// Onboarding Payment Model (MVP - Placeholder for future Stripe implementation)
model OnboardingPayment {
  id                String   @id @default(uuid())
  contractorId      String
  amount            Float
  currency          String   @default("AUD")
  status            String   @default("pending") // pending, completed, failed
  stripePaymentId   String?
  stripeSessionId   String?
  metadata          String?  // JSON string for additional data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([contractorId])
  @@index([status])
}

// Onboarding Progress Model
model OnboardingProgress {
  id           String     @id @default(uuid())
  contractorId String     @unique
  currentStep  Int        @default(1)
  totalSteps   Int        @default(14)
  completed    Boolean    @default(false)
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  metadata     String?    // JSON string for step details

  @@index([contractorId])
}

// Module Progress Model
model ModuleProgress {
  id           String   @id @default(uuid())
  contractorId String
  moduleName   String
  completed    Boolean  @default(false)
  score        Float?
  attempts     Int      @default(0)
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  @@unique([contractorId, moduleName])
  @@index([contractorId])
}

// Subscription Pricing Model (MVP - Placeholder)
model SubscriptionPricing {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  price       Float
  currency    String   @default("AUD")
  interval    String   @default("month") // month, year
  features    String?  // JSON string of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// Error Log Model
model ErrorLog {
  id         String   @id @default(uuid())
  level      String   // error, warning, info
  message    String
  stack      String?
  metadata   String?  // JSON string for additional context
  source     String?  // API route, function name, etc.
  userId     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([level])
  @@index([createdAt])
  @@index([userId])
}

// Audit Log Model
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String   // login, logout, create, update, delete, etc.
  resource   String   // user, contractor, lead, etc.
  resourceId String?
  details    String?  // JSON string of changes
  ipAddress  String?
  userAgent  String?
  success    Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}